<!-- Avatar Upload Section -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Profile Picture</h5>
        <div class="d-flex align-items-center">
            <img th:src="${user.profilePicture != null ? '/api/files/avatar/' + user.profilePicture : '/images/avatar-placeholder.png'}"
                 alt="Profile Picture"
                 class="rounded-circle me-4"
                 width="100" height="100"
                 id="avatarPreview">

            <div>
                <form id="avatarUploadForm" enctype="multipart/form-data">
                    <input type="file" id="avatarFile" name="file" accept="image/*" class="form-control mb-2" style="display: none;">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('avatarFile').click()">
                        <i class="fas fa-upload me-2"></i>Upload New Avatar
                    </button>
                    <small class="form-text text-muted d-block">Max 2MB. Allowed: JPG, PNG, GIF, WEBP</small>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('avatarFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            uploadAvatar(file);
        }
    });

    function uploadAvatar(file) {
        const formData = new FormData();
        formData.append('file', file);

        fetch('/api/files/upload-avatar', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.fileUrl) {
                    // Update avatar preview
                    document.getElementById('avatarPreview').src = data.fileUrl + '?t=' + new Date().getTime();
                    alert('Avatar updated successfully!');
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error uploading avatar');
            });
    }
</script>