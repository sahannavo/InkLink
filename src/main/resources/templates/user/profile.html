<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="layout :: layout(~{::title}, ~{::section})">
<head>
    <title th:text="${user.username} + ' - Profile - InkLink'">User Profile - InkLink</title>
</head>
<body>
<section th:fragment="content">
    <div class="container">
        <!-- Profile Header -->
        <div class="profile-header card mb-4">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <div class="avatar-container position-relative">
                            <img th:src="${user.avatarUrl} ? @{/uploads/avatars/{filename}(filename=${user.avatarUrl}) : @{/images/avatar-placeholder.png}"
                                 alt="Profile picture" class="avatar-image rounded-circle" width="120" height="120">
                            <form th:if="${isOwnProfile}" th:action="@{/profile/avatar}" method="post"
                                  enctype="multipart/form-data" class="avatar-upload-form">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <input type="file" id="avatarInput" name="avatar" accept="image/*" class="d-none">
                                <label for="avatarInput" class="avatar-upload-btn btn btn-primary btn-sm rounded-circle">
                                    <i class="fas fa-camera"></i>
                                </label>
                            </form>
                        </div>
                    </div>
                    <div class="col">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h1 class="h2 mb-1" th:text="${user.username}">Username</h1>
                                <p class="text-muted mb-2" th:if="${user.bio}" th:text="${user.bio}">
                                    User bio will appear here...
                                </p>
                                <p class="text-muted mb-0" th:unless="${user.bio}">
                                    This user hasn't written a bio yet.
                                </p>
                                <div class="profile-stats mt-3">
                                        <span class="me-4">
                                            <strong th:text="${user.storyCount}">0</strong> Stories
                                        </span>
                                    <span class="me-4">
                                            <strong th:text="${user.followerCount}">0</strong> Followers
                                        </span>
                                    <span>
                                            <strong th:text="${user.followingCount}">0</strong> Following
                                        </span>
                                </div>
                            </div>
                            <div th:if="${isOwnProfile}">
                                <a th:href="@{/profile/settings}" class="btn btn-outline-primary">
                                    <i class="fas fa-cog me-2"></i>Settings
                                </a>
                            </div>
                            <div th:unless="${isOwnProfile}">
                                <button class="btn btn-primary follow-btn"
                                        th:classappend="${isFollowing} ? 'btn-outline-primary' : 'btn-primary'"
                                        th:attr="data-user-id=${user.id}">
                                    <i class="fas fa-user-plus me-2" th:classappend="${isFollowing} ? 'fa-user-check' : 'fa-user-plus'"></i>
                                    <span th:text="${isFollowing} ? 'Following' : 'Follow'">Follow</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Navigation Tabs -->
            <div class="col-12">
                <ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="stories-tab" data-bs-toggle="tab"
                                data-bs-target="#stories" type="button" role="tab">
                            <i class="fas fa-book me-2"></i>Stories
                            <span class="badge bg-primary ms-2" th:text="${userStories.size()}">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation" th:if="${isOwnProfile}">
                        <button class="nav-link" id="reading-list-tab" data-bs-toggle="tab"
                                data-bs-target="#reading-list" type="button" role="tab">
                            <i class="fas fa-bookmark me-2"></i>Reading List
                            <span class="badge bg-primary ms-2" th:text="${readingList.size()}">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="about-tab" data-bs-toggle="tab"
                                data-bs-target="#about" type="button" role="tab">
                            <i class="fas fa-user me-2"></i>About
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="tab-content" id="profileTabContent">
                    <!-- Stories Tab -->
                    <div class="tab-pane fade show active" id="stories" role="tabpanel">
                        <div class="row" th:if="${not userStories.empty}">
                            <div class="col-lg-6 mb-4" th:each="story : ${userStories}">
                                <div class="card story-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <span class="badge bg-primary" th:text="${story.category.name}">Category</span>
                                            <div class="dropdown" th:if="${isOwnProfile}">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                                        type="button" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <a class="dropdown-item" th:href="@{/stories/{id}/edit(id=${story.id})}">
                                                            <i class="fas fa-edit me-2"></i>Edit
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <form th:action="@{/stories/{id}/delete(id=${story.id})}"
                                                              method="post" class="d-inline">
                                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                                            <button type="submit" class="dropdown-item text-danger"
                                                                    onclick="return confirm('Are you sure you want to delete this story?')">
                                                                <i class="fas fa-trash me-2"></i>Delete
                                                            </button>
                                                        </form>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        <h5 class="card-title">
                                            <a th:href="@{/stories/{id}(id=${story.id})}" th:text="${story.title}">Story Title</a>
                                        </h5>
                                        <p class="card-text text-muted" th:text="${story.excerpt}">Story excerpt...</p>
                                        <div class="story-meta d-flex justify-content-between text-muted">
                                            <small th:text="${#temporals.format(story.createdAt, 'MMM dd, yyyy')}">Jan 15, 2024</small>
                                            <div>
                                                <small class="me-3">
                                                    <i class="fas fa-heart me-1"></i>
                                                    <span th:text="${story.likeCount}">25</span>
                                                </small>
                                                <small>
                                                    <i class="fas fa-eye me-1"></i>
                                                    <span th:text="${story.viewCount}">150</span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center py-5" th:if="${userStories.empty}">
                            <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                            <h4 th:text="${isOwnProfile} ? 'You haven\\'t written any stories yet' : 'No stories yet'">
                                No stories yet
                            </h4>
                            <p class="text-muted mb-4" th:if="${isOwnProfile}">
                                Start sharing your stories with the world!
                            </p>
                            <a th:href="@{/stories/create}" class="btn btn-primary" th:if="${isOwnProfile}">
                                Write Your First Story
                            </a>
                        </div>
                    </div>

                    <!-- Reading List Tab -->
                    <div class="tab-pane fade" id="reading-list" role="tabpanel" th:if="${isOwnProfile}">
                        <div class="row" th:if="${not readingList.empty}">
                            <div class="col-lg-6 mb-4" th:each="bookmark : ${readingList}">
                                <div class="card story-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <span class="badge bg-primary" th:text="${bookmark.story.category.name}">Category</span>
                                            <form th:action="@{/stories/{id}/bookmark(id=${bookmark.story.id})}"
                                                  method="post" class="d-inline">
                                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-bookmark"></i>
                                                </button>
                                            </form>
                                        </div>
                                        <h5 class="card-title">
                                            <a th:href="@{/stories/{id}(id=${bookmark.story.id})}"
                                               th:text="${bookmark.story.title}">Story Title</a>
                                        </h5>
                                        <p class="card-text text-muted" th:text="${bookmark.story.excerpt}">Story excerpt...</p>
                                        <div class="author-info d-flex align-items-center mb-3">
                                            <img th:src="@{/images/avatar-placeholder.png}"
                                                 alt="Author" class="rounded-circle me-2" width="24" height="24">
                                            <small th:text="${bookmark.story.author.username}">Author Name</small>
                                        </div>
                                        <div class="story-meta d-flex justify-content-between text-muted">
                                            <small th:text="${bookmark.story.readingTime} + ' min read'">5 min read</small>
                                            <small th:text="${#temporals.format(bookmark.bookmarkedAt, 'MMM dd, yyyy')}">
                                                Jan 15, 2024
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center py-5" th:if="${readingList.empty}">
                            <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                            <h4>Your reading list is empty</h4>
                            <p class="text-muted mb-4">Start bookmarking stories to read them later!</p>
                            <a th:href="@{/stories}" class="btn btn-primary">Explore Stories</a>
                        </div>
                    </div>

                    <!-- About Tab -->
                    <div class="tab-pane fade" id="about" role="tabpanel">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">About</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Member Since</h6>
                                        <p class="text-muted" th:text="${#temporals.format(user.createdAt, 'MMMM yyyy')}">
                                            January 2024
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Last Active</h6>
                                        <p class="text-muted" th:text="${#temporals.format(user.lastLogin, 'MMM dd, yyyy')}">
                                            Jan 15, 2024
                                        </p>
                                    </div>
                                </div>
                                <div th:if="${isOwnProfile}" class="mt-4">
                                    <button class="btn btn-outline-primary" data-bs-toggle="modal"
                                            data-bs-target="#editBioModal">
                                        <i class="fas fa-edit me-2"></i>Edit Bio
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Bio Modal -->
    <div class="modal fade" id="editBioModal" tabindex="-1" th:if="${isOwnProfile}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Bio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/profile/bio}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="bio" class="form-label">Bio</label>
                            <textarea class="form-control" id="bio" name="bio" rows="4"
                                      th:value="${user.bio}" placeholder="Tell us about yourself..."></textarea>
                            <div class="form-text">Max 500 characters</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Bio</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>
</body>
</html>